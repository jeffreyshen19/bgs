mapboxgl.accessToken="pk.eyJ1IjoiamVmZnJleXNoZW5jYyIsImEiOiJjamE5MDI4YmowMmMzMndzNDdoZmZnYzF5In0.zV3f0WhqbHeyixwY--TyZg";const map=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/light-v11",center:[-74,40],zoom:6,minZoom:3,projection:"mercator"}),bgSources=["9am8kb0i","40bv3jkg","8yvyazok","bmt0dizu","8noqvw6a","9rvau020","1i3rnvxb"],countySource="5th9xdpz",stateSource="dn2i24or";function getLocation(){return new Promise((e,t)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{e(t.coords)}):t()})}const fieldMapping={medicaid_only:"a",medicaid:"b",medicare_only:"c",medicare:"d",households:"e",snap_households:"f",population:"g",white:"h",black:"i",aian:"j",asian:"k",nhpi:"l",hispanic:"m"},layers={bgs:{minzoom:7,maxzoom:22,sources:["bgs-0","bgs-1","bgs-2","bgs-3","bgs-4","bgs-5","bgs-6"],sourceLayers:["1-simplifed-4oudnq","2-simplifed-54wyov","3-simplifed-ali8na","5-simplifed-8ksaob","4-simplifed-25v6ls","6-simplifed-bd2h7t","7-simplifed-cc5d46"]},counties:{minzoom:5,maxzoom:7,sources:["counties"],sourceLayers:["counties-atvf5u"]},states:{minzoom:0,maxzoom:5,sources:["states"],sourceLayers:["states-34662l"]}};function setLayer(e,t){const a="bgs"===e?t.bgMax:"counties"===e?t.countyMax:t.stateMax,o=["case",["==",["to-number",["get","bgs"===e?fieldMapping[t.weight]:t.weight]],0],"#ffffff",["interpolate",["linear"],["/",["to-number",["get","bgs"===e?fieldMapping[t.name]:t.name]],t.useWeighting?["to-number",["get","bgs"===e?fieldMapping[t.weight]:t.weight]]:1],0,"#ffffff",t.useWeighting?1:a,t.color]],{sources:i,minzoom:n,maxzoom:s,sourceLayers:r}=layers[e];for(let e=0;e<i.length;e++){const t=i[e],a=r[e],l=`${t}-fill-${e}`,c=`${t}-boundary-${e}`;map.getLayer(l)?map.setPaintProperty(l,"fill-color",o):map.addLayer({id:l,type:"fill",minzoom:n,maxzoom:s,source:t,"source-layer":a,paint:{"fill-opacity":.7,"fill-color":o}}),map.getLayer(c)||map.addLayer({id:c,type:"line",source:t,"source-layer":a,minzoom:n,maxzoom:s,paint:{"line-color":["case",["==",["feature-state","click"],!0],"#c44d56","#bdc3c7"],"line-width":["case",["==",["feature-state","click"],!0],3,.5]}})}}function updateMap(){const e=document.getElementById("select"),t=e.options[e.selectedIndex],a={name:e.value,weight:t.getAttribute("data-weighting"),useWeighting:"percent"===document.getElementById("weighting").value,bgMax:+t.getAttribute("data-bg-max"),countyMax:+t.getAttribute("data-county-max"),stateMax:+t.getAttribute("data-state-max"),color:t.getAttribute("data-color")};setLayer("bgs",a),setLayer("counties",a),setLayer("states",a)}function addSources(){for(let e=0;e<bgSources.length;e++){const t=bgSources[e];map.addSource(`bgs-${e}`,{type:"vector",url:`mapbox://jeffreyshencc.${t}`,generqteId:!0})}map.addSource("counties",{type:"vector",url:`mapbox://jeffreyshencc.${countySource}`}),map.addSource("states",{type:"vector",url:`mapbox://jeffreyshencc.${stateSource}`})}map.on("load",()=>{getLocation().then(e=>{e&&map.flyTo({center:[e.longitude,e.latitude],zoom:10})}),addSources(),updateMap()}),map.addControl(new mapboxgl.FullscreenControl,"bottom-right");const nav=new mapboxgl.NavigationControl({visualizePitch:!0});function addCommas(e){var t=e.toString().split(".");const a=t[0],o=t[1];return a.replace(/\B(?=(\d{3})+(?!\d))/g,",")+(o?"."+o:"")}map.addControl(nav,"bottom-right");const popup=new mapboxgl.Popup({closeButton:!0,offset:[0,-15]});let selectedId;function setFeatureState(e,t){for(let a=0;a<layers.bgs.sources.length;a++){const o=layers.bgs.sources[a],i=layers.bgs.sourceLayers[a];map.setFeatureState({source:o,sourceLayer:i,id:e},{click:t})}}function generatePopup(e){const t=map.queryRenderedFeatures(e.point).filter(e=>"fill"===e.layer.type&&("counties"===e.layer.source||"states"===e.layer.source||e.layer.source.startsWith("bgs-")));if(!t.length||t[0].id===selectedId)return void popup.remove();const a=t[0],o=[{name:"medicaid_only",label:"With Medicaid Only",weight:"population"},{name:"medicaid",label:"With Medicaid",weight:"population"},{name:"medicare_only",label:"With Medicare Only",weight:"population"},{name:"medicare",label:"With Medicare",weight:"population"},{name:"snap_households",label:"Households on Food Stamps/SNAP*",weight:"households"},{name:"white",label:"White**",weight:"population"},{name:"black",label:"Black**",weight:"population"},{name:"hispanic",label:"Hispanic/Latine",weight:"population"},{name:"asian",label:"Asian**",weight:"population"},{name:"aian",label:"Alaska Native/American Indian**",weight:"population"},{name:"nhpi",label:"Native Hawaiian/Pacific Islander**",weight:"population"}];let i,n="";for(const e of o){const t=+a.properties[e.name]||+a.properties[fieldMapping[e.name]]||0,o=+a.properties[e.weight]||+a.properties[fieldMapping[e.weight]],i=o?t/o*100:0;n+=`<p style = "margin-top:0;margin-bottom:0"><strong>${e.label}</strong>: ${addCommas(t)}${null!==i?` (${i.toFixed(2)}%)`:""}</p>`,"snap_households"===e.name&&(n+="<br>")}i="states"===a.layer.source?a.properties.NAME:"counties"===a.layer.source?`${a.properties.NAME} County`:"Block Group",popup.setLngLat(e.lngLat).setHTML(`<span class = "heading">${i}</span>\n            ${n}\n            <br>\n            <i>* within the past 12 months</i><br>\n            <i>** non-Hispanic</i>\n            `).addTo(map)}map.on("click",generatePopup);